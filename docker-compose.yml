version: '3.7'
services:

  minio:
    hostname: minio
    image: 'minio/minio:latest'
    container_name: minio
    ports:
      - '9000:9000'
      - '9001:9001'
    volumes:
      - minio-data:/data
    environment:
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123
    command: server /data --console-address ":9001"
    networks:
      - lakehouse

  trino-coordinator:
    image: 'trinodb/trino:latest'
    hostname: trino-coordinator
    ports:
      - '8090:8080'
    volumes:
      - ./trino:/etc/trino
    networks:
      - lakehouse

  spark-master:
    image: bitnami/spark:3.3.2
    environment:
      - SPARK_MODE=master
      - SPARK_MASTER_HOST=spark-master
    ports:
      - "7077:7077"
      - "8080:8080"
      - "4040:4040"
      - "10000:10000"
    volumes:
      - ./spark/data:/data
      - ./spark/src:/src
      - ./spark/app:/app
    working_dir: /app
    command: >
      bash -c 'useradd -r -s /bin/false -U spark &&
       mkdir -p /var/lib/apt/lists/partial &&
       chown -R _apt /var/lib/apt/lists &&
       /opt/bitnami/scripts/spark/run.sh &
       /opt/bitnami/spark/sbin/start-thriftserver.sh'
    user: root
    networks:
    - lakehouse

  spark-worker:
    image: bitnami/spark:3.3.2
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_MEMORY=2g
      - SPARK_WORKER_CORES=1
    ports:
      - '8081:8081'
    volumes:
      - ./spark/data:/data
      - ./spark/src:/src
      - ./spark/app:/app
    working_dir: /app
    user: root
    networks:
      - lakehouse

  jupyter:
    image: jupyter/pyspark-notebook:aarch64-latest
    depends_on:
      - spark-master
      - spark-worker
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - GRANT_SUDO=yes
    ports:
      - '8890:8888'
    volumes:
      - ./spark/data:/data
    working_dir: /data
    user: root
    command: >
      start-notebook.sh --ip 0.0.0.0 --port 8888 --NotebookApp.token='' --NotebookApp.password=''
    networks:
    - lakehouse


volumes:
  minio-data:
    driver: local

networks:
  lakehouse: